version: '3.8'

services:
  # ---------------------------
  # 1. æ ¸å¿ƒæ¨¡å‹æœåŠ¡ (Ollama)
  # ---------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: rag_ollama
    ports:
      - "11434:11434" # PDF æåˆ° 11435ï¼Œä½†å®¹å™¨å†…éƒ¨é€šå¸¸æ˜¯ 11434ï¼Œæˆ‘ä»¬æ˜ å°„å‡ºæ¥
    volumes:
      - ollama_storage:/root/.ollama
    networks:
      - rag_net
    # å¦‚æœä½ æœ‰ NVIDIA æ˜¾å¡ï¼Œä¿ç•™ä¸‹é¢è¿™æ®µï¼›å¦‚æœæ²¡æœ‰ï¼Œè¯·æ³¨é‡Šæ‰ deploy éƒ¨åˆ†
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # ---------------------------
  # 2. å›¾æ•°æ®åº“ (Neo4j)
  # ---------------------------
  neo4j:
    image: neo4j:5.15.0
    container_name: rag_neo4j
    ports:
      - "7474:7474" # HTTP æ§åˆ¶å°
      - "7687:7687" # Bolt åè®®
    environment:
      - NEO4J_AUTH=neo4j/password123
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - rag_net

  # ---------------------------
  # 3. åç«¯ API (RAG Service)
  # ---------------------------
  agent:
    build:
      context: ../            # ğŸŒŸ å…³é”®ï¼šä¸Šä¸‹æ–‡è®¾ä¸ºæ ¹ç›®å½•ï¼Œä»¥ä¾¿è¯»å– data/ å’Œ docs/
      dockerfile: deploy/backend.Dockerfile
    container_name: rag_backend
    ports:
      - "8088:8088"           # ğŸŒŸ åŒ¹é… PDF ä¸­çš„ 8088 ç«¯å£
    volumes:
      # æŒ‚è½½ç´¢å¼•æ–‡ä»¶ï¼Œä¿è¯é‡å¯å Chroma æ•°æ®ä¸ä¸¢å¤±
      - ../index:/app/index
      # æŒ‚è½½ Promptï¼Œæ–¹ä¾¿çƒ­è°ƒæ•´
      - ../prompts:/app/prompts
      # æŒ‚è½½ä»£ç ï¼Œå¼€å‘æ—¶ä¿®æ”¹ä»£ç æ— éœ€é‡å»ºé•œåƒ (å¯é€‰)
      - ../services:/app/services
    environment:
      # å®¹å™¨é—´é€šä¿¡ï¼šä½¿ç”¨æœåŠ¡å (service name)
      - OLLAMA_HOST=http://rag_ollama:11434
      - NEO4J_URI=bolt://rag_neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password123
    depends_on:
      - ollama
      - neo4j
    networks:
      - rag_net

  # ---------------------------
  # 4. å‰ç«¯ç•Œé¢ (React)
  # ---------------------------
  frontend:
    build:
      context: ../
      dockerfile: deploy/frontend.Dockerfile
    container_name: rag_frontend
    ports:
      - "5173:80"             # å°†å®¹å™¨çš„ 80 (Nginx) æ˜ å°„åˆ°å®¿ä¸»æœºçš„ 5173
    depends_on:
      - agent
    networks:
      - rag_net

networks:
  rag_net:
    driver: bridge

volumes:
  ollama_storage:
  neo4j_data:
  neo4j_logs:
